# Phase 4.2 - Inter-Service Communication Security
# Service-to-service authentication and internal API protection

version: '3.8'

services:
  # Service Discovery and Internal Communication
  consul:
    image: consul:1.15.2
    container_name: consul-discovery
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    environment:
      - CONSUL_BIND_INTERFACE=eth0
      - CONSUL_CLIENT_INTERFACE=eth0
    command: agent -server -bootstrap-expect=1 -ui -client=0.0.0.0
    volumes:
      - consul_data:/consul/data
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Internal API Gateway for Service-to-Service Communication
  kong-internal:
    build:
      context: .
      dockerfile: Dockerfile.internal
    container_name: kong-internal-gateway
    ports:
      - "8002:8000"    # Internal gateway proxy port
      - "8003:8001"    # Internal admin API port
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/usr/local/kong/declarative/kong-internal.yml
      - KONG_PROXY_ACCESS_LOG=/dev/stdout
      - KONG_ADMIN_ACCESS_LOG=/dev/stdout
      - KONG_PROXY_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
      - KONG_PROXY_LISTEN=0.0.0.0:8000
      - KONG_LOG_LEVEL=info
      - KONG_PLUGINS=bundled,prometheus
    volumes:
      - ./kong-internal.yml:/usr/local/kong/declarative/kong-internal.yml:ro
      - kong_internal_logs:/var/log/kong
    networks:
      - microservices-network
    depends_on:
      - consul
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Vault for Secret Management
  vault:
    image: vault:1.13.1
    container_name: vault-secrets
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=dev-root-token
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://127.0.0.1:8200
    cap_add:
      - IPC_LOCK
    volumes:
      - vault_data:/vault/data
      - vault_logs:/vault/logs
    networks:
      - microservices-network
    command: vault server -dev -dev-listen-address="0.0.0.0:8200"
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

# Networks
networks:
  microservices-network:
    external: true
    name: microservices-network

# Volumes
volumes:
  consul_data:
    name: consul_data
  vault_data:
    name: vault_data
  vault_logs:
    name: vault_logs
  kong_internal_logs:
    name: kong_internal_logs
