# Kong Declarative Configuration for LOG430 Microservices Gateway
# Phase 3.2 & 3.3 - Advanced Gateway Features and Load Balancing
# This configuration defines all services, routes, upstreams, and plugins for the API Gateway

_format_version: "3.0"
_transform: true

# Services and routes
services:
  # Product Service
  - name: product-service
    url: http://product-service:3001
    routes:
      - name: product-routes
        paths:
          - /products
          - /api/products
        strip_path: false
    tags:
      - microservice
      - product

  # User Service
  - name: user-service
    url: http://user-service:3002
    routes:
      - name: user-routes
        paths:
          - /users
          - /api/users
        strip_path: false
      - name: auth-routes
        paths:
          - /auth
          - /api/auth
        strip_path: false
    tags:
      - microservice
      - user

  # Store Service
  - name: store-service
    url: http://store-service:3003
    routes:
      - name: store-routes
        paths:
          - /stores
          - /api/stores
        strip_path: false
    tags:
      - microservice
      - store

  # Stock Service
  - name: stock-service
    url: http://stock-service:3004
    routes:
      - name: stock-routes
        paths:
          - /stock
          - /api/stock
        strip_path: false
    tags:
      - microservice
      - stock

  # Sales Service
  - name: sales-service
    url: http://sales-service:3005
    routes:
      - name: sales-routes
        paths:
          - /sales
          - /api/sales
        strip_path: false
    tags:
      - microservice
      - sales

  # Refund Service
  - name: refund-service
    url: http://refund-service:3006
    routes:
      - name: refund-routes
        paths:
          - /refunds
          - /api/refunds
        strip_path: false
    tags:
      - microservice
      - refund

  # Cart Service
  - name: cart-service
    url: http://cart-service:3007
    routes:
      - name: cart-routes
        paths:
          - /cart
          - /api/cart
        strip_path: false
    tags:
      - microservice
      - cart

# Load Balancer Upstreams
upstreams:
  # Product Service Load Balancing
  - name: product-upstream
    targets:
      - target: product-service:3001
        weight: 100
      - target: host.docker.internal:3001
        weight: 100
    healthchecks:
      active:
        http_path: /health
        healthy:
          interval: 5
          successes: 1
        unhealthy:
          interval: 5
          http_failures: 2

  # Stock Service Load Balancing
  - name: stock-upstream
    targets:
      - target: stock-service:3004
        weight: 100
      - target: host.docker.internal:3004
        weight: 100
    healthchecks:
      active:
        http_path: /health
        healthy:
          interval: 5
          successes: 1
        unhealthy:
          interval: 5
          http_failures: 2

  # Cart Service Load Balancing
  - name: cart-upstream
    targets:
      - target: cart-service:3007
        weight: 100
      - target: host.docker.internal:3007
        weight: 100
    healthchecks:
      active:
        http_path: /health
        healthy:
          interval: 5
          successes: 1
        unhealthy:
          interval: 5
          http_failures: 2

# Global plugins
plugins:
  # CORS to allow frontend access
  - name: cors
    config:
      origins:
        - http://localhost:5173
        - http://localhost:5174
        - http://localhost:5175
        - http://localhost:3000
      headers:
        - Content-Type
        - Authorization
        - X-API-Key
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      credentials: true
      max_age: 3600

  # Rate limiting
  - name: rate-limiting
    config:
      minute: 60
      policy: local

  # Response transformer
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Powered-By: Kong API Gateway"

# Consumers - Enhanced API Key and JWT management
consumers:
  # Frontend Application Consumer
  - username: frontend-app
    tags:
      - frontend
      - web-client
    keyauth_credentials:
      - key: frontend-app-key-12345
    acls:
      - group: frontend-users
    jwt_secrets:
      - key: frontend-jwt-secret
        algorithm: HS256
        secret: "your-frontend-jwt-secret-change-in-production"
    
  # Mobile Application Consumer  
  - username: mobile-app
    tags:
      - mobile
      - app-client
    keyauth_credentials:
      - key: mobile-app-key-67890
    acls:
      - group: mobile-users
    jwt_secrets:
      - key: mobile-jwt-secret
        algorithm: HS256
        secret: "your-mobile-jwt-secret-change-in-production"
    
  # Admin Dashboard Consumer
  - username: admin-dashboard
    tags:
      - admin
      - dashboard
    keyauth_credentials:
      - key: admin-dashboard-key-abcde
    acls:
      - group: admin-users
    jwt_secrets:
      - key: admin-jwt-secret
        algorithm: HS256
        secret: "your-admin-jwt-secret-change-in-production"
    
  # Testing Consumer
  - username: testing-client
    tags:
      - testing
      - development
    keyauth_credentials:
      - key: testing-key-xyz123
    acls:
      - group: frontend-users
      - group: mobile-users
      - group: admin-users
    jwt_secrets:
      - key: testing-jwt-secret
        algorithm: HS256
        secret: "your-testing-jwt-secret-change-in-production"

